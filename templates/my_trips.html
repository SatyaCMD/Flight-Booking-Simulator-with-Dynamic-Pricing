<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Trips | SkyHigh</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/static/css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>

<body>
    <nav class="navbar">
        <div class="logo">
            <a href="/" style="text-decoration: none; color: inherit;">
                <i class="fas fa-plane-departure"></i> SkyHigh
            </a>
        </div>
        <div class="nav-links">
            <a href="/">Book</a>
            <a href="/my-trips/" class="active">My Trips</a>
            <a href="/check-in/">Check-in</a>
            <a href="/profile/" class="profile-link hidden">Profile</a>
            <a href="/login/" class="login-btn">Login</a>
        </div>
    </nav>

    <main class="container">
        <h1 style="margin-bottom: 2rem;">My Trips</h1>

        <div id="trips-container" style="width: 100%; max-width: 900px;">
            <div class="glass-panel" style="text-align: center; padding: 4rem;">
                <div class="spinner"></div>
                <p style="margin-top: 1rem; color: #94a3b8;">Loading your trips...</p>
            </div>
        </div>
    </main>

    <div id="cancel-modal" class="modal hidden"
        style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); display: flex; align-items: center; justify-content: center; z-index: 2000;">
        <div class="glass-panel"
            style="max-width: 400px; width: 90%; padding: 2rem; text-align: center; background: rgba(17, 34, 64, 0.95); border: 1px solid var(--danger-color);">
            <div
                style="width: 60px; height: 60px; background: rgba(239, 68, 68, 0.1); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 1.5rem;">
                <i class="fas fa-exclamation-triangle" style="font-size: 1.5rem; color: var(--danger-color);"></i>
            </div>
            <h3 style="margin-bottom: 1rem; font-size: 1.5rem;">Cancel Booking?</h3>
            <p style="color: var(--text-muted); margin-bottom: 2rem;">Are you sure you want to cancel
                this booking? This
                action cannot be undone.</p>
            <div style="display: flex; gap: 1rem; justify-content: center;">
                <button id="modal-cancel-close" class="btn"
                    style="background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.1);">No,
                    Keep
                    it</button>
                <button id="modal-cancel-confirm" class="btn"
                    style="background: var(--danger-color); border: none;">Yes, Cancel</button>
            </div>
        </div>
    </div>

    <footer
        style="background: rgba(0, 0, 0, 0.3); padding: 2rem 0; margin-top: auto; border-top: 1px solid rgba(255, 255, 255, 0.1);">
        <div class="container" style="flex-direction: column; align-items: center; gap: 1rem;">
            <div style="display: flex; gap: 2rem; color: #94a3b8;">
                <a href="#" style="color: inherit; text-decoration: none;">About Us</a>
                <a href="#" style="color: inherit; text-decoration: none;">Contact</a>
                <a href="#" style="color: inherit; text-decoration: none;">Privacy Policy</a>
                <a href="#" style="color: inherit; text-decoration: none;">Terms of Service</a>
            </div>
            <div style="color: #64748b; font-size: 0.9rem;">
                &copy; 2025 SkyHigh Airlines. All rights reserved.
            </div>
        </div>
    </footer>

    <script src="/static/js/app.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            const userStr = localStorage.getItem('user');
            if (!userStr) {
                window.location.href = '/login/';
                return;
            }
            const user = JSON.parse(userStr);
            const container = document.getElementById('trips-container');

            try {
                const response = await fetch(`/api/flights/bookings/?email=${encodeURIComponent(user.email)}`);
                if (!response.ok) throw new Error('Failed to fetch bookings');
                const bookings = await response.json();

                if (bookings.length === 0) {
                    container.innerHTML = `
        <div class="glass-panel" style="text-align: center; padding: 4rem;">
            <i class="fas fa-suitcase-rolling" style="font-size: 4rem; color: #64748b; margin-bottom: 1.5rem;"></i>
            <h3>No upcoming trips</h3>
            <p style="color: #94a3b8; margin-bottom: 2rem;">You haven't booked any flights yet.</p>
            <a href="/" class="search-btn" style="display: inline-flex; text-decoration: none;">Book a Flight</a>
        </div>
    `;
                } else {
                    container.innerHTML = '';
                    bookings.forEach(booking => {
                        const date = new Date(booking.booking_date).toLocaleDateString();
                        const card = document.createElement('div');
                        card.className = 'glass-panel';
                        card.style.marginBottom = '1.5rem';
                        card.style.padding = '1.5rem';

                        const passengersHtml = booking.passenger_details.map(p => `
            <div style="background: rgba(255,255,255,0.05); padding: 0.5rem 1rem; border-radius: 0.5rem; font-size: 0.9rem; display: flex; align-items: center; gap: 0.75rem;">
                <div><i class="fas fa-user" style="color: #94a3b8;"></i> ${p.name}</div>
                <div style="height: 15px; width: 1px; background: rgba(255,255,255,0.2);"></div>
                <div style="color: var(--primary-color); font-weight: 600;"><i class="fas fa-chair" style="font-size: 0.8rem; margin-right: 0.3rem;"></i> ${p.seat_number || 'Unassigned'}</div>
            </div>
        `).join('');

                        card.innerHTML = `
            <div style="display: flex; justify-content: space-between; align-items: flex-start; flex-wrap: wrap; gap: 1rem;">
                <div>
                    <div style="font-size: 0.9rem; color: #94a3b8; margin-bottom: 0.5rem;">
                        PNR: <span style="color: var(--primary-color); font-weight: 700; margin-right: 1rem;">${booking.booking_reference}</span>
                        <span style="font-size: 0.8rem; opacity: 0.7;">TXN: ${booking.transaction_id || 'N/A'}</span>
                    </div>
                    <h3 style="font-size: 1.5rem; margin-bottom: 0.5rem;">Flight ${booking.flight_number}</h3>
                    <div style="color: #cbd5e1;">Booked on ${date}</div>
                </div>
                <div style="text-align: right;">
                    <div style="background: rgba(16, 185, 129, 0.2); color: #34d399; padding: 0.25rem 0.75rem; border-radius: 1rem; font-size: 0.85rem; display: inline-block; margin-bottom: 0.5rem;">
                        ${booking.status}
                    </div>
                    <div style="font-size: 0.9rem; color: #94a3b8; margin-bottom: 0.5rem;">${booking.passenger_details.length} Passenger(s)</div>
                    <div style="display: flex; gap: 0.5rem; justify-content: flex-end;">
                        <button class="btn-receipt" data-id="${booking.transaction_id || booking.booking_reference}" style="background: rgba(34, 197, 94, 0.1); color: #22c55e; border: 1px solid rgba(34, 197, 94, 0.2); padding: 0.25rem 0.75rem; border-radius: 4px; cursor: pointer; font-size: 0.8rem; transition: all 0.2s;">
                            <i class="fas fa-ticket-alt"></i> View Ticket
                        </button>
                        <button class="btn-cancel" data-id="${booking.transaction_id || booking.booking_reference}" style="background: rgba(239, 68, 68, 0.1); color: #ef4444; border: 1px solid rgba(239, 68, 68, 0.2); padding: 0.25rem 0.75rem; border-radius: 4px; cursor: pointer; font-size: 0.8rem; transition: all 0.2s;">
                            <i class="fas fa-times"></i> Cancel
                        </button>
                    </div>
                </div>
            </div>
            <div style="margin-top: 1.5rem; padding-top: 1rem; border-top: 1px solid rgba(255,255,255,0.1);">
                <h4 style="font-size: 1rem; margin-bottom: 0.5rem; color: #94a3b8;">Passengers</h4>
                <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
                    ${passengersHtml}
                </div>
            </div>
        `;
                        container.appendChild(card);
                    });

                    const cancelModal = document.getElementById('cancel-modal');
                    const confirmBtn = document.getElementById('modal-cancel-confirm');
                    const closeBtn = document.getElementById('modal-cancel-close');
                    let bookingIdToCancel = null;

                    document.querySelectorAll('.btn-cancel').forEach(btn => {
                        btn.addEventListener('click', (e) => {
                            bookingIdToCancel = e.target.closest('button').dataset.id;
                            cancelModal.classList.remove('hidden');
                            cancelModal.style.display = 'flex';
                        });
                    });

                    document.querySelectorAll('.btn-receipt').forEach(btn => {
                        btn.addEventListener('click', (e) => {
                            const bookingId = e.currentTarget.dataset.id;
                            const url = `/api/flights/bookings/receipt/${bookingId}/`;
                            window.open(url, '_blank');
                        });
                    });

                    closeBtn.addEventListener('click', () => {
                        cancelModal.classList.add('hidden');
                        cancelModal.style.display = 'none';
                        bookingIdToCancel = null;
                    });

                    const newConfirmBtn = confirmBtn.cloneNode(true);
                    confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);

                    newConfirmBtn.addEventListener('click', async () => {
                        if (!bookingIdToCancel) return;

                        const originalText = newConfirmBtn.textContent;
                        newConfirmBtn.textContent = 'Cancelling...';
                        newConfirmBtn.disabled = true;

                        try {
                            const res = await fetch(`/api/flights/bookings/cancel/${bookingIdToCancel}/`, {
                                method: 'POST'
                            });
                            if (res.ok) {
                                window.location.reload();
                            } else {
                                alert('Failed to cancel booking.');
                                newConfirmBtn.textContent = originalText;
                                newConfirmBtn.disabled = false;
                            }
                        } catch (err) {
                            console.error(err);
                            alert('Error cancelling booking.');
                            newConfirmBtn.textContent = originalText;
                            newConfirmBtn.disabled = false;
                        }
                    });
                }
            } catch (err) {
                console.error(err);
                container.innerHTML = `
    <div class="glass-panel" style="text-align: center; padding: 2rem;">
        <p style="color: #ef4444;">Failed to load trips. Please try again later.</p>
    </div>
`;
            }
        });
    </script>
</body>
</html>
